<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scrollytelling Timeline - Smooth Fade (Mobile fixed)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { margin:0; font-family:"Noto Sans Bengali", system-ui, sans-serif; background:#000; }

    /* Sticky timeline header */
    .timeline-sticky{
      position: sticky; top: 0; z-index: 50;
      background:#fff;
      border-bottom: 1px solid #eee;
      padding: 14px 16px 10px;
    }
    .topline{ display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .title{ font-weight: 800; }

    .timeline-wrap{ position: relative; height: 72px; margin-top: 10px; }
    .track{ position:absolute; left:0; right:0; top:28px; height:6px; border-radius:999px; background:#eee; }
    .progress{ position:absolute; left:0; top:28px; height:6px; border-radius:999px; background:#111; width:0%; transition: width 240ms ease; }
    .playhead{ position:absolute; top:18px; left:0%; width:18px; height:18px; border-radius:50%; background:#111; transform:translateX(-50%); transition:left 240ms ease; }

    .ticks{ position:absolute; left:0; right:0; top:20px; height:24px; pointer-events:none; }
    .tick{ position:absolute; top:0; width:10px; height:24px; transform:translateX(-50%); display:flex; align-items:flex-end; justify-content:center; }
    .tick::before{ content:""; width:2px; height:14px; border-radius:2px; background:#bbb; }
    .tick.is-active::before{ background:#111; height:18px; }

    .activeTimeCenter{
      position:absolute; left:50%; top:46px; transform:translateX(-50%);
      font-size: 13px; color:#444; font-weight:600; white-space:nowrap;
    }

    .labels{ margin-top: 8px; display:flex; justify-content:space-between; font-size:12px; color:#666; }

    /* ===== Cross-fade background stage ===== */
    .bgStage{
      position: sticky;
      top: 108px; /* below header */
      height: calc(100dvh - 126px);
      z-index: 1;
      overflow: hidden;
      background:#111;
    }
    @supports not (height: 100dvh){
      .bgStage{ height: calc(100vh - 126px); }
    }

    .bgLayer{
      position:absolute; inset:0;
      background-size: cover;
      background-position: center;
      will-change: opacity;
      transition: opacity 520ms ease;
      opacity: 0;
    }
    .bgLayer.is-visible{ opacity: 1; }

    .bgOverlay{
      position:absolute; inset:0;
      background: linear-gradient(
        to bottom,
        rgba(0,0,0,.20) 0%,
        rgba(0,0,0,.42) 45%,
        rgba(0,0,0,.68) 100%
      );
      z-index: 3;
      pointer-events:none;
    }

    /* Steps layer */
    .scrolly{
      position: relative;
      z-index: 10;
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 16px 90px;
    }

    .step{
      min-height: 110vh; /* give more scroll distance */
      display:flex;
      align-items:flex-end;
      position: relative;
    }

    .card{
      position: sticky;
      bottom: 22px;
      width: 360px;
      max-width: calc(100% - 32px);
      margin-right: auto;

      background: rgba(240,240,240,.78);
      border: 1px solid rgba(255,255,255,.55);
      border-radius: 18px;
      padding: 14px 14px 16px;
      box-shadow: 0 14px 36px rgba(0,0,0,.30);
      backdrop-filter: blur(7px);

      opacity: 0;
      transform: translateY(22px);
      transition: opacity 280ms ease, transform 280ms ease;
      will-change: opacity, transform;

      max-height: 55vh;
      overflow-y: auto;
    }

    .step.is-active .card{
      opacity: 1;
      transform: translateY(0);
    }

    .when{ font-size: 12px; color:#111; opacity:.75; margin-bottom: 6px; }
    .card h3{ margin:0 0 8px 0; font-size: 20px; font-weight: 800; color:#111; }
    .card p{ margin:0; line-height: 1.7; font-size: 14px; color:#222; }

    /* Mobile tuning */
    @media (max-width: 900px){
      .bgStage{ top: 92px; }
      .step{ min-height: 135vh; } /* IMPORTANT: more scroll room on mobile */
      .card{ width: 320px; bottom: 16px; }
    }
    @media (max-width: 420px){
      .card{ width: calc(100% - 20px); }
    }
  </style>
</head>

<body>
  <header class="timeline-sticky">
    <div class="topline">
      <div class="title">ঢাকা: সংবাদপত্র অফিসে হামলা — স্ক্রল টাইমলাইন</div>
    </div>

    <div class="timeline-wrap">
      <div class="track"></div>
      <div class="progress" id="progress"></div>
      <div class="playhead" id="playhead"></div>
      <div class="ticks" id="ticks"></div>
      <div class="activeTimeCenter" id="activeTime">সময়: —</div>
    </div>

    <div class="labels">
      <span>১৮ ডিসেম্বর ১০:০০ PM</span>
      <span>১৯ ডিসেম্বর ০৬:০০ PM</span>
    </div>
  </header>

  <div class="bgStage" aria-hidden="true">
    <div class="bgLayer is-visible" id="bgA"></div>
    <div class="bgLayer" id="bgB"></div>
    <div class="bgOverlay"></div>
  </div>

  <main class="scrolly">
    <section id="steps"></section>
  </main>

  <script src="https://unpkg.com/scrollama"></script>
  <script>
    if ("scrollRestoration" in history) history.scrollRestoration = "manual";
    window.addEventListener("load", () => window.scrollTo(0, 0));

    const SCENES = Array.from({length: 12}, (_, i) => {
      const n = i + 1;
      return {
        id: "s" + n,
        progress: i / 11,
        timeLabel: (n===11) ? "১৯ ডিসেম্বর ০১:৪৫ PM" : "ডামি সময়",
        titleBn: (n===11) ? "বিতর্ক/পাল্টাপাল্টি" : "ডামি শিরোনাম " + n,
        longText: "ডামি লং টেক্সট: এই অংশে বিস্তারিত বর্ণনা থাকবে। আপনি চাইলে এখানে ৫০/১০০ শব্দও দিতে পারবেন।",
        image: "assets/scene" + n + ".jpg"
      };
    });

    // Build steps with cards
    const stepsRoot = document.getElementById("steps");
    SCENES.forEach((s, idx) => {
      const el = document.createElement("div");
      el.className = "step";
      el.dataset.index = idx;
      el.innerHTML = `
        <div class="card">
          <div class="when">${s.timeLabel}</div>
          <h3>${s.titleBn}</h3>
          <p>${escapeHtml(s.longText)}</p>
        </div>
      `;
      stepsRoot.appendChild(el);
    });

    // Ticks
    const ticksRoot = document.getElementById("ticks");
    const tickEls = [];
    SCENES.forEach((s) => {
      const t = document.createElement("div");
      t.className = "tick";
      t.style.left = (Math.max(0, Math.min(1, s.progress)) * 100) + "%";
      ticksRoot.appendChild(t);
      tickEls.push(t);
    });

    const playhead = document.getElementById("playhead");
    const progressBar = document.getElementById("progress");
    const activeTime = document.getElementById("activeTime");

    // Crossfade backgrounds
    const bgA = document.getElementById("bgA");
    const bgB = document.getElementById("bgB");
    let front = bgA, back = bgB;
    let currentIdx = -1;

    function crossFadeTo(url){
      back.style.backgroundImage = `url("${url}")`;
      back.classList.add("is-visible");
      front.classList.remove("is-visible");
      const tmp = front; front = back; back = tmp;
    }

    function renderScene(idx){
      const s = SCENES[idx];
      const pct = Math.max(0, Math.min(1, s.progress)) * 100;

      if (idx !== currentIdx) {
        if (currentIdx === -1) {
          front.style.backgroundImage = `url("${s.image}")`;
          front.classList.add("is-visible");
        } else {
          crossFadeTo(s.image);
        }
        currentIdx = idx;
      }

      playhead.style.left = pct + "%";
      progressBar.style.width = pct + "%";
      tickEls.forEach(x => x.classList.remove("is-active"));
      tickEls[idx]?.classList.add("is-active");
      activeTime.textContent = "সময়: " + (s.timeLabel || "—");
    }

    // Smooth fade-out based on real step progress (mobile-safe)
    function setCardProgress(stepEl, progress){
      const card = stepEl.querySelector(".card");
      if (!card) return;

      // Keep fully visible until ~65% of the step
      const hold = 0.65;
      const fadeSpan = 0.30; // fade from 0.65 -> 0.95
      let alpha = 1;

      if (progress > hold) {
        const t = Math.min(1, (progress - hold) / fadeSpan);
        alpha = 1 - t; // down to 0
      }

      // Ensure it never instantly disappears
      alpha = Math.max(0.05, alpha);

      card.style.opacity = String(alpha);
      card.style.transform = `translateY(${(1 - alpha) * -12}px)`;
    }

    const scroller = scrollama();
    scroller.setup({ step: ".step", offset: 0.6, progress: true })
      .onStepEnter(({ element, index }) => {
        document.querySelectorAll(".step").forEach(x => x.classList.remove("is-active"));
        element.classList.add("is-active");
        renderScene(index);
        setCardProgress(element, 0);
      })
      .onStepProgress(({ element, progress }) => {
        // progress: 0..1 within the step
        setCardProgress(element, progress);
      })
      .onStepExit(({ element }) => {
        // reset styles so next time it enters it's clean
        const card = element.querySelector(".card");
        if (card) {
          card.style.opacity = "";
          card.style.transform = "";
        }
      });

    // initial
    renderScene(0);
    document.querySelector(".step")?.classList.add("is-active");

    function onResize(){ scroller.resize(); }
    window.addEventListener("resize", onResize);
    window.addEventListener("orientationchange", onResize);
    setTimeout(onResize, 80);
    setTimeout(onResize, 350);

    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, ch => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[ch]));
    }
  </script>
</body>
</html>
